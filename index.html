<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>IRBSpeedApp</title>
    <base href="/" />

    <!-- App icons & PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0A3D62" />

    <!-- Styles -->
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="IRBSpeedApp.styles.css" rel="stylesheet" />
</head>
<body>
    <div id="app">…loading UI…</div>
    <div id="blazor-error-ui">…error UI…</div>

    <script src="_framework/blazor.webassembly.js"></script>

    <!-- Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .catch(() => {/* silent */});
      });
    }
    </script>

    <!-- GPS & Accelerometer Interop -->
    <script>
    let watchId, dotNetHelper = null, lastPosition = null;
    const maxAccuracy = 20, speedAlpha = 0.3, accelAlpha = 0.2, accelThreshold = 2;
    let lastSpeed = 0, lastAccelX = 0;

    function registerDotNetHelper(helper) {
      dotNetHelper = helper;
    }

    function startTracking(helper) {
      dotNetHelper = helper;
      if (!navigator.geolocation) return;

      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, speed: rawMps, accuracy } = pos.coords;
          if (accuracy > maxAccuracy) return;

          // raw km/h
          let rawKmh = rawMps != null
            ? rawMps * 3.6
            : (lastPosition
               ? (calculateDistance(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude,
                    latitude, longitude
                  ) / ((pos.timestamp - lastPosition.timestamp)/1000)) * 3.6
               : 0);

          lastPosition = { coords: pos.coords, timestamp: pos.timestamp };

          // smooth GPS
          let smoothKmh = speedAlpha * rawKmh + (1 - speedAlpha) * lastSpeed;
          lastSpeed = smoothKmh < 5 ? 0 : smoothKmh;  // clamp below 5 km/h

          dotNetHelper?.invokeMethodAsync('ReportGps', lastSpeed)
            .catch(() => {});
        },
        () => {/* error ignored */},
        { enableHighAccuracy: true, timeout: Infinity, maximumAge: 0 }
      );
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null; lastPosition = null;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000, toRad = d => d * Math.PI/180;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function enableMotion() {
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(resp => { if (resp==='granted') attachMotion(); })
          .catch(() => {});
      } else {
        attachMotion();
      }
    }

    function attachMotion() {
      window.addEventListener('devicemotion', ev => {
        const rawX = ev.acceleration?.x || 0;
        // filter sudden jolts
        const delta = Math.abs(rawX - lastAccelX);
        const filtered = delta > accelThreshold ? lastAccelX : rawX;
        const smoothX = accelAlpha * filtered + (1 - accelAlpha) * lastAccelX;
        lastAccelX = smoothX;

        dotNetHelper?.invokeMethodAsync('ReportAccel', smoothX)
          .catch(() => {});
      });
    }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</body>
</html>
